---
title: 如何用 VSCode 远程调试开发
author: zhang
date: 2023-06-21 15:00:00 +0800
categories: [Blogging, Development]
tags: [development]
---

## VSCode 环境配置

### 1. 前置工作

远程服务器默认已经安装 Python/C++ 运行环境，对于 Python 开发推荐使用 Anaconda 进行 Python 环境管理，假设已安装 Anaconda；本地服务器已安装 VSCode IDE，网络与远程服务器互通

### 2. 远程 SSH 插件安装与配置

在 VSCode 扩展中安装 `Remote-SSH`

![ssh remote](/images/2023-06/ssh_remote.png)

安装后会新增一个远程资源管理器，单击后左侧弹出远程目录，点击“设置”图标，命令窗口弹出配置选项，选择第一个 `/Users/zhangsibo/.ssh/config` 

![ssh config](/images/2023-06/ssh_config.png)

该配置文件格式如下，其中 `Host` 是自己给服务器起的名字，`HostName` 是服务器 IP 地址，`User` 是登陆服务所使用的用户名

```
Host Guangzhou
    HostName 124.71.215.192
    User root

Host Singapore
    HostName 119.8.160.205
    User root

Host onnxruntime_ci
    HostName 119.8.187.17
    User root
```

配置后远程资源管理器会显示服务列表，点击后面的箭头，在命令窗口输入密码即可连接到远程服务器，并可以打开远程文件夹

![ssh connect](/images/2023-06/ssh_connect.png)

如果不想每次连接远端服务器或打开文件夹都输入密码，可以利用 `ssh-keygen` 命令在本地生成密钥，并将公钥复制到远端服务器

```bash
# 在本地执行，查看公钥
cat ~/.ssh/id_rsa.pub

# 在远端执行
vim ~/.ssh/authorized_keys 

# 复制公钥后按wq保存退出
```

### 3. Python 插件安装与配置

分别在本地和远端服务器安装 `Python` 和 `Jupyter` 插件

![python](/images/2023-06/python.png)

此时，打开远端服务器的 notebook 脚本后会有选择内核选项，但选择 Python 环境后无法找到 Anaconda 管理的 Python 环境，还需在 Anaconda 中安装相应软件包

![python kernel](/images/2023-06/python_kernel.png)

分别在 Anaconda 的 base 环境和自建环境进行安装

```bash
# 进入 base 环境
conda activate base

# 安装 nb_conda_kernel
conda install nb_conda_kernels

# 进入自建环境
conda activate my_env

# 安装 ipykernel
conda install ipykernel
```
安装后重启 VSCode，再次连接远程服务器，打开 notebook 脚本后可以选择 Anaconda 管理的 Python 环境

### 4. C/C++ 插件安装与配置

在扩展中安装 `C/C++ Extension Pack`，安装后打开远端项目文件夹，由于代码运行在远端，VSCode 会提示在远端安装相应的扩展，点击安装即可

![c++](/images/2023-06/cpp.png)

登陆远端服务器，安装 GDB

```bash
sudo apt-get install gdb
```

并在 VSCode 中安装 `GDB Debugger` 扩展

![gdb](/images/2023-06/gdb.png)

## Debug 配置（待更新）
<!-- 
### 1. 配置文件及作用

- `${workspaceFolder}/.vscode/launch.json`：debug 功能模块参数配置文件
- `${workspaceFolder}/.vscode/c_cpp_properties.json`：编辑器窗口关于 C/C++ 的配置文件
- `${workspaceFolder}/.vscode/settings.json`：编辑器窗口的配置文件
- `${workspaceFolder}/.env`：编辑器窗口的环境变量配置文件
  
其中，`${workspaceFolder}` 代表 VSCode 当前打开的文件夹路径，`launch.json` 和其它三个文件有部分参数配置重叠的部分，但作用域不同。例如，在 `launch.json` 配置了 `LD_LIBRARY_PATH` 只能保证在 Debug 阶段程序能正常调用，但在编辑器窗口想要通过鼠标快速跳转至对应源代码，还需在 `c_cpp_properties.json` 中配置 `includePath`。

### 2. Python Debug 配置


### 3. C/C++ Debug 配置





##### 配置 `launch.json`
该文件主要配置启动命令，当前目录，环境变量。依次点击左侧“运行和调试”图标，“创建 launch.json 文件”，并选择 `GDB Debug` 调试器
![launch](figures/2/launch.png)

完成后在 `.vscode` 目录下生成 `launch.json` 配置文件，删除原有的 `configurations` 字段的内容，点击右下角“添加配置”，并选择“(gdb)启动”，会自动添加配置字段
![config](figures/2/config.png)

`C/C++: (bdb)` 启动自动配置如下，后面会详细介绍几种场景如何配置
```json
// .vscode/launch.json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "(gdb) 启动",
            "type": "cppdbg",
            "request": "launch",
            "program": "输入程序名称，例如 ${workspaceFolder}/a.out",
            "args": [],
            "stopAtEntry": false,
            "cwd": "${fileDirname}",
            "environment": [],
            "externalConsole": false,
            "MIMode": "gdb",
            "setupCommands": [
                {
                    "description": "为 gdb 启用整齐打印",
                    "text": "-enable-pretty-printing",
                    "ignoreFailures": true
                },
                {
                    "description": "将反汇编风格设置为 Intel",
                    "text": "-gdb-set disassembly-flavor intel",
                    "ignoreFailures": true
                }
            ]
        }
    ]
}
```

##### 配置 `c_cpp_properties.json`
该文件主要配置头文件地址，若头文件没有正确引入，debug 程序可能正常运行，但无法跳转至头文件声明的函数中，在本项目调试阶段，该配置文件始终如下：
```json
// .vscode/c_cpp_properties.json
{
    "configurations": [
        {
            "name": "Linux",
            "includePath": [
                "/root/Projects/onnxruntime/include/onnxruntime",
                "/root/Projects/onnxruntime/onnxruntime"
            ]
        }
    ],
    "version": 4
}
```

##### 配置 `setting.json`
```json
{
    "files.associations": {
        "array": "cpp",
        "sstream": "cpp",
        "bitset": "cpp",
        "memory_resource": "cpp",
        "*.tcc": "cpp"
    },
    "python.envFile": "${workspaceFolder}/.env",
}
```

##### 配置 `.env`
```shell
{
PYTHONPATH=/root/Projects/onnxruntime/build/Linux/RelWithDebInfo:/root/Projects/onnxruntime/build/Linux/RelWithDebInfo/onnxruntime:/root/Projects/onnxruntime/build/Linux/RelWithDebInfo/onnxruntime/capi:/usr/local/Ascend/ascend-toolkit/latest/pyACL/python/site-packages:/usr/local/Ascend/ascend-toolkit/latest/opp/op_impl/built-in/ai_core/tbe:/usr/local/Ascend/ascend-toolkit/latest/toolkit/latest/acllib/lib64
}
```

##### 情况1：调试项目编译好的测试二进制文件
```json
// debug文件 ～/Projects/onnxruntime/build/Linux/RelWithDebInfo/onnxruntime_mlas_test
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "(gdb) 启动",
            "type": "cppdbg",
            "request": "launch",
            "program": "${workspaceFolder}/build/Linux/RelWithDebInfo/onnxruntime_mlas_test",
            "args": [],
            "stopAtEntry": false,
            "cwd": "${workspaceFolder}/build/Linux/RelWithDebInfo/",
            "environment": [],
            "externalConsole": false,
            "MIMode": "gdb",
            "setupCommands": [
                {
                    "description": "为 gdb 启用整齐打印",
                    "text": "-enable-pretty-printing",
                    "ignoreFailures": true
                },
                {
                    "description": "将反汇编风格设置为 Intel",
                    "text": "-gdb-set disassembly-flavor intel",
                    "ignoreFailures": true
                }
            ]
        }
    ]
}

```

##### 情况2：调试项目自带的 python 测试脚本
```json
// debug文件 ～/Projects/onnxruntime/build/Linux/RelWithDebInfo/onnxruntime_test_python_mlops.py
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "(gdb) 启动",
            "type": "cppdbg",
            "request": "launch",
            "program": "/root/anaconda3/envs/onnxruntime/bin/python",
            "args": ["onnxruntime_test_python_mlops.py"],
            "stopAtEntry": false,
            "cwd": "${workspaceFolder}/build/Linux/RelWithDebInfo/",
            "environment": [],
            "externalConsole": false,
            "MIMode": "gdb",
            "setupCommands": [
                {
                    "description": "为 gdb 启用整齐打印",
                    "text": "-enable-pretty-printing",
                    "ignoreFailures": true
                },
                {
                    "description": "将反汇编风格设置为 Intel",
                    "text": "-gdb-set disassembly-flavor intel",
                    "ignoreFailures": true
                }
            ]
        }
    ]
}
```
##### 情况3：调试自己的 python 脚本
```json
// debug文件 ～/Projects/ort_debug/sess_run.py
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "(gdb) 启动",
            "type": "cppdbg",
            "request": "launch",
            "program": "/root/anaconda3/envs/onnxruntime/bin/python",
            "args": ["sess_run.py"],
            "stopAtEntry": false,
            "cwd": "${workspaceFolder}",
            "environment": [
                {
                    "name": "PYTHONPATH",
                    "value": "/root/Projects/onnxruntime/build/Linux/RelWithDebInfo:/usr/local/Ascend/ascend-toolkit/latest/pyACL/python/site-packages:/usr/local/Ascend/ascend-toolkit/latest/opp/op_impl/built-in/ai_core/tbe:/usr/local/Ascend/ascend-toolkit/latest/toolkit/latest/acllib/lib64"
                }
            ],
            "externalConsole": false,
            "MIMode": "gdb",
            "setupCommands": [
                {
                    "description": "为 gdb 启用整齐打印",
                    "text": "-enable-pretty-printing",
                    "ignoreFailures": true
                },
                {
                    "description": "将反汇编风格设置为 Intel",
                    "text": "-gdb-set disassembly-flavor intel",
                    "ignoreFailures": true
                }
            ]
        }
    ]
}
```

##### 情况4：调试自己的 C++ 编译的程序

```shell
# 文件路径 /root/Projects/ort_debug/sess_run1.cc
cd /root/Projects/ort_debug/

# 编译命令
g++ sess_run1.cc -o sess_run -g -O0 -I/root/Projects/onnxruntime/include/onnxruntime -L/root/Projects/onnxruntime/build/Linux/RelWithDebInfo -lonnxruntime
```

配置文件 `/root/Projects/ort_debug/.vscode/launch.json`
```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "(gdb) 启动",
            "type": "cppdbg",
            "request": "launch",
            "program": "${workspaceFolder}/sess_run",
            "args": ["models/debug.onnx"],
            "stopAtEntry": false,
            "cwd": "${workspaceFolder}",
            "environment": [
                {
                    "name": "LD_LIBRARY_PATH",
                    "value": "/root/Projects/onnxruntime/build/Linux/RelWithDebInfo:/usr/local/Ascend/ascend-toolkit/latest/x86_64-linux/lib64/"
                }

            ],
            "externalConsole": false,
            "MIMode": "gdb",
            "setupCommands": [
                {
                    "description": "为 gdb 启用整齐打印",
                    "text": "-enable-pretty-printing",
                    "ignoreFailures": true
                },
                {
                    "description": "将反汇编风格设置为 Intel",
                    "text": "-gdb-set disassembly-flavor intel",
                    "ignoreFailures": true
                }
            ]
        }
    ]
}
```


#### 3.调试小技巧（更新）

##### VSCode 调试中屏蔽标准库函数跳转

在 `.vscode/launch.json` 配置文件中的 `setupCommands` 字段添加下面内容
```json
{
    "description": "防止 gdb 打开标准库函数",
    "text": "-interpreter-exec console \"skip -rfu std::.*\"",
    "ignoreFailures": false
}
```
 -->
